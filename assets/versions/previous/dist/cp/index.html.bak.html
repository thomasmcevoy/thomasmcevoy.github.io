<!doctype html>
<html lang="en">
<head>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: auto;
      max-width: 48em;
      color: #222;
      font-family: futura;
      text-align: center;
      letter-spacing: .025em;
    }
    h1 {
      margin: .875em 0 0;
      font-size: 3em;
      letter-spacing: .075em;
    }
    h2 {
      margin: 1.375em 0 0;
      font-size: .875em;
      letter-spacing: .55em;
    }
    h3 {
      margin: 2.25em 0 .75em;
      font-size: 1.875em;
      letter-spacing: .125em;
    }
    input {
      margin: .125rem;
      border: none;
      resize: none;
      text-align: center;
    }
    .show {
      display: inline-block;
      width: 16em;
      padding: .125em .25em 1.5em;
      border: solid 2px white;
    }
    .show:hover {
      border-color: #eee;
    }
    .day {
      width: 1.25em;
      height: 1.25em;
      font-size: 7em;
      font-weight: 100;
    }
    .venue {
      font-size: 1.25em;
      color: #bf9600;
    }
    .band,
    .time {
      font-size: .8125em;
    }
  </style>
  <script src="lib/react.js"></script>
  <script src="lib/JSXTransformer.js"></script>
  <script src="lib/jquery.min.js"></script>
</head>

<body>
  <h1>Control Panel</h1>
  <div id="content">
  <script type="text/jsx">
    var ShowsBox = React.createClass({
      getInitialState: function() {
        return {
          shows: []
        }
      },
      componentDidMount: function() {
        $.ajax({
          url: this.props.url,
          dataType: 'json',
          success: function(data) {
            this.setState({shows: data});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },
      saveChanges: function() {
        $.ajax({
          url: this.props.url,
          dataType: 'json',
          type: 'POST',
          data: this.state.shows,
          success: function(data) {
            this.setState({shows: data});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },
      updateShows: function(shows){
        this.setState({
          shows: shows
        })
      },
      render: function() {
        return (
          <div className="showsBox">
            <h2>EDIT SHOWS</h2>
            <ShowsList shows={this.state.shows} update={this.updateShows} />
            <button onClick={this.saveChanges}> SAVE CHANGES </button>
          </div>
        )
      }
    });

    var ShowsList = React.createClass({
      getInitialState: function(){
        return {
          shows: this.props.shows
        };
      },
      updateShows: function(shows){
        this.props.update(shows);
      },
      handleChange: function(e){
        this.setState({
          shows: e.target.value
        });
        this.updateShows(this.state.shows);
      },
      render: function() {
        var showNodes = this.props.shows.map(function (show) {
          return (
            <Show show={show} update={this.updateShows} />
          );
        });
        return (
          <div className="showsList" onChange={this.handleChange}>
            <h3 className="month">February</h3>
            {showNodes}
          </div>
        );
      }
    });

    var Show = React.createClass({
      getInitialState: function() {
        return {
          show: this.props.show
        }
      },
      updateShows: function(show){
        this.props.update(show);
      },
      handleChange: function(e) {
        this.setState({
          show: {
            day: this.refs.day.getDOMNode().value,
            venue: this.refs.venue.getDOMNode().value,
            band: this.refs.band.getDOMNode().value,
            time: this.refs.time.getDOMNode().value
          }
        });
        this.updateShows(this.state.show);
      },
      render: function() {
        return (
          <div className="show">
            <input type="text" ref="day" className="day" value={this.state.show.day} onChange={this.handleChange} />
            <input type="text" ref="venue" className="venue" value={this.state.show.venue} onChange={this.handleChange} />
            <input type="text" ref="band" className="band" value={this.state.show.band} onChange={this.handleChange} />
            <input type="text" ref="time" className="time" value={this.state.show.time} onChange={this.handleChange} />
          </div>
        )
      }
    });

    React.render(
      <ShowsBox url="shows.json" />,
      document.getElementById('content')
    );
  </script>
</body>
</html>
